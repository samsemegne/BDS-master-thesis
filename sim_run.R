

sim_run = function(args) {
  seed = args$seed
  data_type = args$data_type

  aql = args$aql
  rql = args$rql
  dql = args$dql
  alpha = args$alpha
  beta = args$beta
  batch_size = args$batch_size

  set.seed(seed)
  batch_series = simulate_lot_series(args)

  set.seed(seed)
  proc1__lqas = AcceptanceSampling_lqas_procedure(
    batch_series, aql, rql, alpha, beta
  )

  attr(proc1__lqas, "run_id") = seed
  path = save_procedure(proc1__lqas)
  cli_status_update(proc1__lqas, path)

  if (is.null(proc1__lqas$error) && is.null(proc1__lqas$warnings)) {
    # Perform lot sampling, as specified by the previously obtained LQAS plan.
    set.seed(seed)
    lot_series = proc1__lqas$result$lot_series
    rm(proc1__lqas)

    # BSSM model 1
    set.seed(seed)
    proc2__cbssm = custom_bssm_procedure(
      lot_series, get_model1x(), aql, rql, seed
    )

    attr(proc2__cbssm, "run_id") = seed
    path = save_procedure(proc2__cbssm, "_model1")
    cli_status_update(proc2__cbssm, path)
    rm(proc2__cbssm)

    # BSSM model 2
    #set.seed(seed)
    #proc3__cbssm = custom_bssm_procedure(
    #  lot_series, get_model2(), aql, rql, seed
    #)
    #
    #attr(proc3__cbssm, "run_id") = seed
    #path = save_procedure(proc3__cbssm, "_model2")
    #cli_status_update(proc3__cbssm, path)
    #rm(proc3__cbssm)
  }
}


create_sim_run_params = function(num_runs, data_type) {
  stopifnot(vek::is_int_vec_x1(num_runs))
  stopifnot(vek::is_chr_vec_xb1(data_type))
  stopifnot(data_type %in% c("1", "2", "3", "4"))
  
  seed = NULL
  if (num_runs == 1L)
    seed = get_seed1()
  else if (num_runs == 2L)
    seed = get_seed2()
  else if (num_runs == 3L)
    seed = get_seed3()
  else if (num_runs == 4L)
    seed = get_seed4()
  else
    stop("num_runs token not recognized")
  
  new_df(
    seed = seed,
    t_len = 100L,
    batch_size = 1000L,
    aql = .025,
    rql = .1,
    dql = .025,
    alpha = .05,
    beta = .1,
    data_type = data_type,
    mu_prop = .0375,
    sigma_prop = .001
  )
}


cli_status_update = function(object, label) {
  stopifnot(exprs = {
    is.procedure(object)
    vek::is_chr_vec_x1(label)
  })

  if (!is.null(object$warnings)) {
    cli::cli_alert_warning(sprintf("`%s` exited with warnings", label))
    for (w in get_warning_messages(object))
      cli::cli_alert_warning(w)
  }

  if (!is.null(object$error)) {
    cli::cli_alert_danger(sprintf("`%s` exited with error", label))
    e_msg = object$error$message %||% "[error message empty]"
    cli::cli_alert_danger(sprintf("1. %s", e_msg))
  }

  if (is.null(object$error) && is.null(object$warnings))
    cli::cli_alert_success(sprintf("`%s` OK", label))
}


get_seed1 = function() {
  # Original
  #c(1003940396, 1012080624, 1012152210, 101223570, 102240072, 1048989344, 1054473577, 1057440509, 1073766772, 108241266, 1085127992, 1097897337, 1099548553, 1100958894, 1152568922, 1158424212, 1159252719, 1166667269, 1187148074, 1225678864, 128216998, 1282597546, 13311627, 1332922765, 1371115601, 1383245456, 1396523456, 1433002489, 1460779965, 1462816841, 1508653373, 1516351756, 1539282370, 1542598996, 1554998566, 1572074835, 1578266876, 1584371120, 1585126666, 1624412072, 1634022467, 1634523217, 1640360628, 1641088002, 164904485, 1652402705, 1681436314, 1703319574, 172718801, 1748662826, 1760162283, 1774700633, 1776050043, 1830555495, 1846808275, 1849601071, 1860719325, 1872303601, 1882133345, 1886817443, 1887510538, 1895444702, 1901256640, 1933388216, 1985312159, 1989113531, 2029716658, 203399589, 2039520987, 2043017225, 2048742507, 2062894424, 2067738126, 2075346033, 2080138126, 2080336945, 208173997, 2097782010, 210714277, 2114989505, 2124887061, 218597994, 223700177, 231819966, 245792505, 255863801, 258815421, 271134637, 28195157, 306363941, 308958687, 311482045, 326099889, 327506568, 35194403, 357216104, 37514464, 426074747, 431010586, 494129930, 501926, 50847679, 513074458, 513513705, 525546778, 542658979, 556081689, 557974861, 560173350, 564122832, 571031334, 57389433, 5943705
  #) |> as.integer()
  
  # 3
  c(809124837L, 1291168765L, 1271770673L, 57799817L, 15700581L, 2002779201L, 868357237L, 53253218L, 115033651L, 1475420274L, 1540954665L, 533864376L, 234585182L, 1300198476L, 1243656899L, 1153494830L, 1264449064L, 880714688L, 1458518124L, 1208360631L, 607973120L, 275817437L, 1111446408L, 1516942610L, 988659786L, 1311759144L, 466984602L, 525802943L, 1827712588L, 1559898931L)
  
  # 2
  #c(468604242L,
  #         1449150176L,
  #         373806645L,
  #         305640426L,
  #         853964487L,
  #         1876594667L,
  #         1840331520L,
  #         952658836L,
  #         1432477029L,
  #         761036363L,
  #         1845596276L,
  #         670759555L,
  #         997080486L,
  #         1274926313L,
  #         487519900L,
  #         632693957L,
  #         1826324942L,
  #         665082155L,
  #         686444497L,
  #         1509959130L,
  #         682372961L,
  #         1951589850L,
  #         1905703236L,
  #         1590675441L,
  #         47902905L,
  #         2120637311L,
  #         1063635709L,
  #         884177360L,
  #         2124500701L,
  #         837604003L
  #       )
}


get_seed2 = function() {
  # Original
  #c(
  #  1019445404, 1033695374, 1050517587, 1069721271, 1092544612, 1095447819, 1101778622, 1108824768, 1111886884, 1135910308, 1154631268, 1156704680, 1205660451, 1220717846, 1226410006, 1227229316, 1234207567, 1235880645, 1237543972, 1239492219, 1257661789, 1258091140, 1271251231, 1274913102, 129116509, 1308845975, 132603019, 1345936395, 138267047, 1383896682, 1385763519, 1425909966, 1451843422, 146785214, 147414343, 1477650051, 1479236636, 1491947004, 1494859790, 1504937143, 1514679331, 1517640646, 1554389393, 1568979597, 1621732832, 1636006381, 1637721541, 1653752353, 1663356711, 1663939574, 1668977361, 1673331210, 1704372228, 1715725693, 1726372488, 1730500642, 1743035074, 1757451431, 178065300, 1795677462, 1798525756, 182447783, 1841305894, 1843700789, 1844942630, 1856953752, 1877051974, 188754036, 1900489065, 1909214093, 1910514831, 1915764731, 1934043784, 1935577085, 1947300287, 1951884190, 195253831, 1987845951, 1988250585, 1995057248, 1998300654, 200600857, 2007832300, 2021293271, 2046542098, 2052813657, 2066464630, 2080991993, 2082853659, 2099097845, 2102699882, 2113610760, 2115032865, 2137852650, 232005156, 253668021, 257899910, 266567592, 272680751, 27652433, 295907608, 305513375, 306862449, 30910830, 322999328, 33677573, 343543444, 35589667, 359714777, 359947487, 361144810, 398555413, 402934787
  #) |> as.integer()
  
  # 3
  c(423265489L, 534111358L, 1568749503L, 1635212782L, 1923701495L, 1129407853L, 332903932L, 797139176L, 1996976408L, 755098057L, 879856964L, 359654882L, 1024144325L, 68002142L, 912490311L, 400284341L, 2122251111L, 1991616510L, 397411734L, 1696840862L, 1285509885L, 1098557903L, 1956132493L, 397729777L, 1461554377L, 1530282977L, 286082738L, 861950600L, 70967960L, 938318403L)
  
  # 2
  #c(
  #  1670044255L,
  #  1481934649L,
  #  247746573L,
  #  1096766654L,
  #  1631698485L,
  #  698979063L,
  #  1327164668L,
  #  154398052L,
  #  1165008609L,
  #  1325947028L,
  #  1480485433L,
  #  75111527L,
  #  1840966299L,
  #  976712124L,
  #  1518085365L,
  #  755124435L,
  #  1717309300L,
  #  862046031L,
  #  339564444L,
  #  934521462L,
  #  2077850048L,
  #  1769190560L,
  #  1163999678L,
  #  1865073173L,
  #  44904986L,
  #  572110203L,
  #  791971535L,
  #  1059524857L,
  #  1115699592L,
  #  1559418380L
  #)
}


get_seed3 = function() {
  #c(
  #  100235820, 1002956682, 1039965102, 1051133041, 1054773438, 1057563309, 1083085341, 1089961228, 1094976768, 1101373941, 1101499093, 1109300525, 1133104285, 114027973, 1140350788, 1143358521, 1147691737, 1158971242, 1163122726, 1168917197, 1170871631, 1188262126, 1215204756, 1219319922, 1229486364, 1241260329, 1248063682, 1257763998, 1263737763, 1264961214, 1269218683, 1275829967, 127650324, 1293157755, 1312923818, 1315754206, 1322159474, 133270274, 1344257026, 1351371985, 1358398662, 1371294375, 1376354664, 1378461094, 1382233291, 1404859233, 1404940353, 1406053153, 1416271835, 1431775634, 1450881622, 1452553640, 1457925264, 1460354861, 1485038097, 1492357159, 1516842872, 1531292096, 1532988940, 1534417253, 1550535551, 1563216832, 1564155661, 1577661410, 1577938287, 157823706, 1587068665, 1587828514, 1592822244, 1619921364, 1625962000, 1626164276, 1632225031, 1632386291, 1638490172, 1641156751, 16449014, 1659176306, 166758368, 168275246, 1700028387, 1708435097, 171386216, 1753790815, 1756143997, 1767972831, 1783827715, 1797413394, 1803340557, 180795771, 1813677197, 1814573530, 1820312300, 1820436560, 1828596964, 1840263800, 1854137002, 1859386394, 1864035607, 1867003471, 1873820506, 1881620140, 1883998640, 1896629114, 1902808593, 1909893419, 1927774374, 1933186131, 1934366601, 1945183975, 1966016030, 2008688539, 2020096389
  #) |> as.integer()
  
  # 3
  #c(1657712024L, 153965522L, 2043402298L, 56699784L, 1074409256L, 846785741L, 1641790347L, 107121573L, 1503159273L, 1366377029L, 2120452384L, 858037189L, 829757902L, 1632870908L, 132721145L, 1427604267L, 685949679L, 2124131748L, 630922148L, 1136553160L, 897317005L, 1710988577L, 270774885L, 1730246118L, 1257135852L, 1937552150L, 981141154L, 1440066535L, 1501147656L, 463802893L)
  
  # 3-1
  c(2100099519L, 16449014L, 1797413394L, 1248063682L, 473528744L, 39390601L, 133270274L, 1625962000L, 247510969L, 1089961228L, 1933186131L, 1966016030L, 720000553L, 333003428L, 507285616L, 1322159474L, 2041161204L, 1756143997L, 1767972831L, 1376354664L, 2043304437L, 157823706L, 1315754206L, 513898649L, 1577938287L, 981769939L, 1083085341L, 547051047L, 1002956682L, 39061598L)
  
  # 3-2 not used yet
  #c(860905602L, 433585623L, 1854137002L, 1820436560L, 940190525L, 1133104285L, 171386216L, 1163122726L, 475722441L, 963615591L, 1431775634L, 1641156751L, 2008688539L, 772120677L, 168275246L, 1592822244L, 830035556L, 959980563L, 834294445L, 1532988940L, 1516842872L, 1264961214L, 800881804L, 563055162L, 1873820506L, 1859386394L, 1531292096L, 257813163L, 1828596964L, 1269218683L)
  
  # 2
  #c(
  #  1773292330L,
  #  1971672344L,
  #  647971342L,
  #  2055324717L,
  #  361881622L,
  #  1456330470L,
  #  1488999795L,
  #  2045961320L,
  #  1564828631L,
  #  1191114220L,
  #  1866839656L,
  #  1717982027L,
  #  1104163812L,
  #  906764072L,
  #  1054352560L,
  #  1029181207L,
  #  611180628L,
  #  1197919261L,
  #  1955358972L,
  #  1335204573L,
  #  664492652L,
  #  1160773153L,
  #  573322901L,
  #  555645542L,
  #  1821415753L,
  #  2045164375L,
  #  1532128886L,
  #  636552026L,
  #  925833835L,
  #  1916773342L
  #)
}


get_seed4 = function() {
  #c(
  #  1002956682, 1006759345, 1022520189, 1031468018, 1037980937, 1042309453, 1042311305, 1046583249, 1051133041, 1059872266, 1083085341, 1083833593, 108450750, 10847655, 1089961228, 1094976768, 1112495739, 1120690602, 1122746792, 1130763446, 1132006421, 1133104285, 114027973, 1163122726, 1168917197, 1177816255, 1179405450, 1184703291, 1186803645, 1208222203, 1247072868, 1248063682, 1259086976, 1264961214, 1269218683, 1270854676, 1278426792, 1285294648, 1288761707, 1295676237, 1312923818, 1315754206, 132092876, 1322159474, 133270274, 1340796266, 1351371985, 1351431317, 1373192735, 1376354664, 1387060064, 1393296683, 1416271835, 1426643108, 1431775634, 1439901967, 1449343289, 1460938333, 1478859867, 1483816445, 1487109911, 1488971358, 1494148627, 151668534, 1516842872, 1531292096, 1532988940, 1537586980, 1563216832, 156640327, 1570150818, 1577938287, 157823706, 1588179437, 1592109732, 1592228858, 1592822244, 1593086053, 1614487276, 1619921364, 162487597, 1625962000, 1626164276, 1628397484, 1632386291, 1638490172, 1641156751, 16449014, 1645219669, 164870273, 165917050, 1666706560, 1676644008, 1680420185, 1681683425, 168275246, 1686943578, 1706626009, 171139485, 1713125278, 171386216, 171569073, 1717385535, 1725724413, 1727979627, 1753790815, 1754459177, 1756143997, 1761748689, 1766559476, 1767972831, 17837, 1789586687
  #) |> as.integer()
  
  # 3
  #c(424910855L, 957843359L, 56003628L, 993439697L, 28205648L, 1713327787L, 16271127L, 321468014L, 1752835488L, 1660876902L, 1411654014L, 2140093434L, 496603858L, 1955599985L, 391552847L, 1786060010L, 1794168089L, 313191118L, 1549350289L, 495801162L, 1260456731L, 86872775L, 1951859698L, 1108210337L, 2109921365L, 1351091178L, 1548092406L, 1834385183L, 669703725L, 142548549L)
  
  # 3-1
  #c(1773292330L, 1971672344L, 647971342L, 2055324717L, 361881622L, 1456330470L, 1488999795L, 2045961320L, 1564828631L, 1191114220L, 1866839656L, 1717982027L, 1104163812L, 906764072L, 1054352560L, 1029181207L, 611180628L, 1197919261L, 1955358972L, 1335204573L, 664492652L, 1160773153L, 573322901L, 555645542L, 1821415753L, 2045164375L, 1532128886L, 636552026L, 925833835L, 1916773342L)
  
  # 3-2
  #c(1140350788L, 312928385L, 866248189L, 1909893419L, 554504146L, 884616499L, 803234389L, 1158971242L, 934673902L, 1632225031L, 1867003471L, 651436069L, 1147691737L, 57500133L, 1587828514L, 2070518142L, 2119708588L, 1406053153L, 1263737763L, 960850250L, 1378461094L, 1215204756L, 127650324L, 100235820L, 997765463L, 2051398777L, 1881620140L, 303569271L, 1358398662L, 695822375L)
  
  # 2
  #c(
  #  2112454368L,
  #  2080255079L,
  #  1094415411L,
  #  47985954L,
  #  982096001L,
  #  321524667L,
  #  152675471L,
  #  1840879901L,
  #  261588650L,
  #  2083488245L,
  #  785095167L,
  #  1025917464L,
  #  984904668L,
  #  752205608L,
  #  450944339L,
  #  492408483L,
  #  1412068353L,
  #  1846862L,
  #  127210310L,
  #  1192965748L,
  #  1223222565L,
  #  1916585902L,
  #  1634757059L,
  #  274028003L,
  #  960910958L,
  #  560125747L,
  #  1529570353L,
  #  1634264380L,
  #  619822520L,
  #  452323121L
  #)
}